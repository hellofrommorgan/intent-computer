# Universal Kernel — Fifteen Universal Primitives
# Every system generated by arscontexta includes these.
# The kernel is constant. The derivation engine varies everything above it.
# Full automation is the default — users may opt down.

schema_version: 3

primitives:
  - id: markdown-yaml
    name: Markdown files with YAML frontmatter
    description: Notes are plain text files with structured metadata. The file IS the complete artifact.
    layer: foundation
    requires: filesystem
    enforcement: invariant
    validation:
      check: Every .md file has valid YAML frontmatter (--- delimited block)
      threshold: ">95% of note files"
    cognitive_grounding: "Cognitive offloading (Clark & Chalmers Extended Mind) — external structures extend thinking beyond context window limits"

  - id: wiki-links
    name: Wiki links as graph edges
    description: "[[note title]] creates navigable relationships. Filenames are unique; links resolve by name."
    layer: foundation
    requires: filesystem, unique-filenames
    enforcement: invariant
    validation:
      check: All wiki links resolve to existing files
      threshold: ">90% resolution (allows planned/example links)"
    cognitive_grounding: "Spreading activation — reading one note primes related notes through explicit edges"

  - id: moc-hierarchy
    name: MOC hierarchy for attention management
    description: Maps of Content organize notes into navigable topic areas. Hub → domain → topic → notes.
    layer: convention
    requires: wiki-links
    enforcement: invariant
    validation:
      check: At least 3 MOCs exist. Every note appears in at least one MOC.
      threshold: "<5% orphan notes after initial creation window"
    cognitive_grounding: "Context-switching cost (Leroy 2009) — MOCs reduce 23-minute reorientation penalty by presenting topic state immediately"

  - id: tree-injection
    name: Tree injection at session start
    description: Agent sees full file structure immediately. Provides orientation before action.
    layer: convention
    requires: filesystem
    enforcement: invariant
    implementation:
      claude-code: SessionStart hook injects tree output
      minimal: Context file instructs agent to ls at start
    validation:
      check: Session start procedure loads file structure
    cognitive_grounding: "Orientation before action — prevents wasting context on discovery"

  - id: description-field
    name: Description field for progressive disclosure
    description: "YAML description (~150 chars) adds information beyond the title. Enables filter-before-read."
    layer: convention
    requires: markdown-yaml
    enforcement: invariant
    validation:
      check: Every note has a description field that differs from the title
      threshold: ">95% of notes"
    cognitive_grounding: "Progressive disclosure — each layer reveals more but costs more tokens. Stop at the level you need."

  - id: topics-footer
    name: Topics footer linking notes to MOCs
    description: "Every note declares which MOC(s) it belongs to via topics field."
    layer: convention
    requires: moc-hierarchy, markdown-yaml
    enforcement: invariant
    validation:
      check: "topics field present on every non-MOC note with at least one wiki link"
      threshold: ">95% of notes"
    cognitive_grounding: "Bidirectional navigation — MOCs link down to notes, notes link up to MOCs"

  - id: schema-enforcement
    name: Schema enforcement via validation
    description: Templates define required fields and enums. Validation checks notes against templates.
    layer: convention
    requires: markdown-yaml
    enforcement: invariant
    implementation:
      tier-1: Hook-based validation (PostToolUse event)
      tier-2: Batch validation script
      tier-3: Context file instructions for manual checking
    validation:
      check: Templates exist as single source of truth. Validation mechanism catches missing required fields.
    cognitive_grounding: "Instruction compliance degrades as context fills — deterministic validation catches what instruction-following misses"

  - id: self-space
    name: Self space for agent persistent memory
    description: "Dedicated directory for identity, methodology, goals. Read at session start, updated at session end."
    layer: convention
    requires: markdown-yaml, moc-hierarchy
    enforcement: configurable
    structure:
      required:
        - identity.md
        - methodology.md
        - goals.md
      optional:
        - relationships.md
        - memory/
        - sessions/
        - journal/
    validation:
      check: "self/ exists with identity.md, methodology.md, goals.md populated"
    cognitive_grounding: "Session handoff — externalized state gives each fresh session a briefing from the previous one"

  - id: session-rhythm
    name: "Session rhythm: orient, work, persist"
    description: "Three-phase cycle encoded in context file. Orient (read state), work (execute + capture), persist (update + push)."
    layer: convention
    requires: markdown-yaml
    enforcement: invariant
    validation:
      check: "Context file documents orient/work/persist cycle. Session start loads orientation state."
    cognitive_grounding: "Closure rituals (Newport) prevent attention residue. Orientation prevents cold starts. Together they bracket productive sessions."

  - id: semantic-search
    name: Semantic search capability
    description: Meaning-based discovery across vocabularies. Complements structural navigation.
    layer: automation
    requires: wiki-links
    enforcement: configurable
    implementation:
      tier-1: "Embedding tool (qmd, MCP server)"
      tier-2: "LLM-assisted similarity search"
      tier-3: "Periodic manual review guided by topic adjacency"
    validation:
      check: "Given a note, the mechanism returns related notes that share no significant keywords"
    cognitive_grounding: "Vocabulary divergence — same concept, different words. Structural graph traversal misses these connections."

  - id: unique-addresses
    name: Filesystem graph database
    description: "The vault is a graph database on the filesystem. Markdown files are nodes, wiki links are edges, YAML frontmatter is the property store, ripgrep is the query engine. Three query levels: field-level (rg on YAML), node-level (backlinks, link extraction), graph-level (scripts combining traversal + analysis)."
    layer: foundation
    requires: wiki-links, markdown-yaml
    enforcement: invariant
    validation:
      check: "ops/scripts/graph/ directory exists with core analysis scripts. /graph skill generated. At minimum: orphan detection, dangling link detection, backlink counting, link density measurement, forward/backward traversal, synthesis opportunity detection."
    cognitive_grounding: "Structured data enables queries that unstructured files cannot answer. The graph structure emerges from kernel invariants without additional infrastructure."

  - id: discovery-first
    name: Discovery-first quality gate
    description: "Everything created must be optimized for future agent discovery. If an agent can't find a note, the note doesn't exist."
    layer: convention
    requires: description-field, topics-footer
    enforcement: invariant
    enforcement_detail:
      context-file: "Discovery-First Design section — BEFORE creating any note, ask how will a future session find this?"
      skills: "Every skill that creates notes includes a discovery check before writing"
      hooks: "PostToolUse hook on Write validates discovery criteria (when platform supports hooks)"
      learning: "When a note IS hard to find, system captures observation about why"
    validation:
      check: "Generated context file contains Discovery-First Design section. Generated skills include discovery checks. If hooks supported, PostToolUse validation hook exists."
    cognitive_grounding: "Discoverability compounds — the system's value grows through findability. Every note that can't be found is negative value."

  - id: operational-learning-loop
    name: Operational learning loop
    description: "The system accumulates friction signals (observations, tensions) and periodically reviews them to evolve itself."
    layer: convention
    requires: schema-enforcement
    enforcement: invariant
    components:
      observation-capture:
        description: "After every significant action, the agent asks: what did I learn? Creates atomic note in ops/observations/ with prose-sentence title and structured YAML."
        schema:
          required: [description, category, observed, status]
          category_values: [methodology, process, friction, surprise, quality]
          status_values: [pending, promoted, implemented, archived]
      tension-capture:
        description: "When any skill discovers content that contradicts existing notes or system assumptions, IMMEDIATELY creates atomic note in ops/tensions/."
        schema:
          required: [description, observed, involves, status]
          status_values: [pending, resolved, dissolved]
      threshold-review:
        description: "When pending observations exceed 10 or pending tensions exceed 5, session-start orient surfaces suggestion to run /{DOMAIN:rethink}."
        thresholds:
          observations: 10
          tensions: 5
    implementation:
      tier-1: "PostToolUse hook logs friction automatically. Skill-integrated tension detection. /{DOMAIN:rethink} command with session-start threshold check."
      tier-2: "Context file instructs agent to log after significant actions. Context file instructs immediate tension capture. Context file documents threshold + manual review trigger."
      tier-3: "Agent instructed to note friction in ops/. Agent instructed to note contradictions. Periodic human-triggered review."
    validation:
      check: "ops/observations/ and ops/tensions/ directories exist. Review trigger (threshold or condition) documented in context file. /{DOMAIN:rethink} command or equivalent exists."
    cognitive_grounding: "Scientific method applied to knowledge systems — hypothesize, implement, observe, revise. Systems that cannot observe their own friction cannot evolve."

  - id: task-stack
    name: Task stack
    description: "The lifecycle backbone. Every note flows through a task state. ops/tasks.md is the human-readable view; ops/queue/ holds the unified queue with both pipeline tasks (claims, enrichments) and maintenance tasks (auto-generated from condition evaluation, auto-closed when satisfied)."
    layer: convention
    requires: markdown-yaml, session-rhythm
    enforcement: invariant
    validation:
      check: "ops/tasks.md exists. Queue file exists with schema_version >= 3. Context file references both in session-orient phase. /next reads task stack AND reconciles maintenance conditions in the queue."
    cognitive_grounding: "Without task tracking, the agent has no lifecycle visibility. Cannot answer 'what should I work on?' or 'what processing is pending?'"

  - id: methodology-folder
    name: Methodology folder
    description: "The vault's self-knowledge. ops/methodology/ contains linked notes explaining why the vault is configured the way it is, what processing pipeline it uses, and how it has evolved. Content types: derivation-rationale, kernel-state, pipeline-config, maintenance-conditions, vocabulary-map, configuration-state."
    layer: convention
    requires: markdown-yaml, moc-hierarchy, operational-learning-loop
    enforcement: invariant
    validation:
      check: "ops/methodology/ directory exists with methodology.md MOC. At least one derivation-rationale note exists. Context file references ops/methodology/ for meta-skill context. /remember writes to ops/methodology/. Meta-skills read from it."
    cognitive_grounding: "Without self-knowledge, meta-skills operate blind. /ask cannot explain config choices. /architect cannot reason about changes. /remember has nowhere to capture corrections."

  - id: session-capture
    name: Session capture
    description: "Every session transcript is saved automatically. Stop hooks save transcripts to ops/sessions/. Auto-creates mining tasks. Friction detection runs on transcripts — the system catches what was missed during the session."
    layer: automation
    requires: session-rhythm, operational-learning-loop
    enforcement: invariant
    validation:
      check: "ops/sessions/ directory exists. Session-end hook saves transcripts. Condition-based mining trigger exists for unprocessed sessions."
    cognitive_grounding: "The operational learning loop depends on evidence. Session transcripts contain every redirection and correction — mining them catches what explicit /remember misses."

# Dependency graph (DAG):
# markdown-yaml → description-field
# markdown-yaml → topics-footer
# markdown-yaml → schema-enforcement
# markdown-yaml → self-space
# markdown-yaml → session-rhythm
# wiki-links → moc-hierarchy → topics-footer
# wiki-links → semantic-search
# wiki-links + markdown-yaml → unique-addresses
# description-field → discovery-first
# topics-footer → discovery-first
# schema-enforcement → operational-learning-loop
# markdown-yaml + session-rhythm → task-stack
# markdown-yaml + moc-hierarchy + operational-learning-loop → methodology-folder
# session-rhythm + operational-learning-loop → session-capture
# tree-injection (standalone)

# Layer mapping:
# foundation: markdown-yaml, wiki-links, unique-addresses
# convention: moc-hierarchy, tree-injection, description-field, topics-footer, schema-enforcement, self-space, session-rhythm, discovery-first, operational-learning-loop, task-stack, methodology-folder
# automation: semantic-search, session-capture
